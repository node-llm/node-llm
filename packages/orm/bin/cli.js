#!/usr/bin/env node
/**
 * @node-llm/orm migration generator
 *
 * Usage:
 *   npx @node-llm/orm init          # Generate schema.prisma
 *   npx @node-llm/orm migrate       # Create and apply migration
 */

import { writeFileSync, existsSync, mkdirSync } from "fs";
import { join } from "path";

const SCHEMA_TEMPLATE = `// This is your Prisma schema file
// Generated by @node-llm/orm

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NodeLLM ORM Models
model LlmLlmChat {
  id           String    @id @default(uuid())
  model        String?
  provider     String?
  instructions String?   @db.Text
  metadata     String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  messages     LlmMessage[]
  requests     LlmRequest[]

  @@index([createdAt])
}

model LlmLlmMessage {
  id           String      @id @default(uuid())
  chatId       String
  role         String
  content      String?     @db.Text
  contentRaw   String?     @db.Text
  reasoning    String?     @db.Text
  inputTokens  Int?
  outputTokens Int?
  modelId      String?
  provider     String?
  createdAt    DateTime    @default(now())

  chat         LlmChat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  toolCalls    LlmToolCall[]
  requests     LlmRequest[]

  @@index([chatId])
  @@index([createdAt])
}

model LlmToolCall {
  id           String   @id @default(uuid())
  messageId    String
  toolCallId   String
  name         String
  arguments    String   @db.Text
  result       String?  @db.Text
  createdAt    DateTime @default(now())

  message      LlmMessage  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([createdAt])
}

model LlmRequest {
  id           String   @id @default(uuid())
  chatId       String
  messageId    String?
  
  provider     String
  model        String
  statusCode   Int
  duration     Int
  inputTokens  Int
  outputTokens Int
  cost         Float?
  
  createdAt    DateTime @default(now())

  chat         LlmChat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  message      Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([createdAt])
}
`;

function init() {
  const cwd = process.cwd();
  const prismaDir = join(cwd, "prisma");
  const schemaPath = join(prismaDir, "schema.prisma");

  // Create prisma directory if it doesn't exist
  if (!existsSync(prismaDir)) {
    mkdirSync(prismaDir, { recursive: true });
    console.log("✓ Created prisma/ directory");
  }

  // Check if schema already exists
  if (existsSync(schemaPath)) {
    console.log("⚠️  schema.prisma already exists");
    console.log("   To add NodeLLM models, manually copy from:");
    console.log("   node_modules/@node-llm/orm/schema.prisma");
    return;
  }

  // Write schema
  writeFileSync(schemaPath, SCHEMA_TEMPLATE);
  console.log("✓ Generated prisma/schema.prisma");
  console.log("\nNext steps:");
  console.log("  1. Update DATABASE_URL in .env");
  console.log("  2. Run: npx prisma migrate dev --name init");
  console.log("  3. Run: npx prisma generate");
}

function migrate() {
  console.log("Running Prisma migration...");
  console.log("\nPlease run:");
  console.log("  npx prisma migrate dev --name add_nodellm_orm");
}

function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  switch (command) {
    case "init":
      init();
      break;
    case "migrate":
      migrate();
      break;
    default:
      console.log("@node-llm/orm - Database migration tool\n");
      console.log("Usage:");
      console.log("  npx @node-llm/orm init     # Generate schema.prisma");
      console.log("  npx @node-llm/orm migrate  # Create migration");
      console.log("\nFor custom table names, see:");
      console.log(
        "  https://github.com/node-llm/node-llm/tree/main/packages/orm#custom-table-names"
      );
  }
}

main();
